<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pix</title>
  <script type="text/javascript" src="https://raw.githubusercontent.com/mpizenberg/elm-pep/master/elm-pep.js"></script>
  <script type="text/javascript" src="elm.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Red+Hat+Display:ital,wght@0,300..900;1,300..900&display=swap');

    body {
      margin: 0;
      overflow: auto;

      font-family: "Red Hat Display", sans-serif;
      font-optical-sizing: auto;
      font-weight: 500;
      font-style: normal;
    }
  </style>
</head>

<body>
  <div id="shell"></div>
</body>
<script type="text/javascript">

  // function point(x, y) {
  //   return { x: x, y: y };
  // }

  // MAIN
  var shell = document.getElementById('shell');

  var app = window.Elm.Main.init({
    node: shell
  });

  // app.ports.canvasRulerPressed.send(point(x, y));

  //var canvasRuler = document.getElementById('canvasRuler');

  //canvasRuler.addEventListener('click', function (event) {
  //  const target = event.target;
  //  const rect = target.getBoundingClientRect();
  //  let x = Math.floor(event.clientX - rect.left);
  //  let y = Math.floor(event.clientY - rect.top);
  //  app.ports.canvasRulerPressed.send(point(x, y));
  //});

  function triggerDownload(imgURI, filename) {
    const a = document.createElement('a');
    a.download = filename + '.png';
    a.target = '_blank';
    a.href = imgURI;

    a.dispatchEvent(new MouseEvent('click', {
      view: window,
      bubbles: false,
      cancelable: true
    }));
  }

  function downloadSvg(svgNode, filename, width, height) {
    const svgString = (new XMLSerializer()).serializeToString(svgNode);
    const svgBlob = new Blob([svgString], {
      type: 'image/svg+xml;charset=utf-8'
    });

    const DOM_URL = window.URL || window.webkitURL || window;
    const url = DOM_URL.createObjectURL(svgBlob);

    const image = new Image();
    image.width = width;
    image.height = height;
    image.src = url;
    image.onload = function () {
      const canvas = document.createElement('canvas');
      canvas.width = image.width;
      canvas.height = image.height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(image, 0, 0);
      DOM_URL.revokeObjectURL(url);

      const imgURI = canvas
        .toDataURL('image/png')
        .replace('image/png', 'image/octet-stream');
      triggerDownload(imgURI, filename);
    };
  }

  // const canvas = document.getElementById('canvas');
  // const rect = canvas.getBoundingClientRect();
  // downloadSvg(canvas, 'pix', rect.width, rect.height);

</script>

</html>
